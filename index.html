<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>3D Love Galaxy</title>

<style>
html,body{
    margin:0;height:100%;
    background:#000;overflow:hidden;
    font-family:Arial, sans-serif;
}

#intro{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:url('assets/background.jpg') no-repeat center center/cover;
    display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    z-index:10;
}

#heartBtn{
    width:200px;height:200px;
    cursor:pointer;
    margin-bottom:20px;
}

#loadingBar{
    width:50%;
    height:20px;
    background:#ffc0e0;
    border-radius:10px;
    overflow:hidden;
    opacity:0;
    box-shadow:0 2px 6px rgba(255, 115, 185, 0.5);
}

#loadingFill{
    width:0%;
    height:100%;
    background:#FF69B4;
    box-shadow:0 0 12px #ff95ca, 0 0 20px #FF1493;
    border-radius:10px;
}

#flash{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:white;opacity:0;pointer-events:none;transition:opacity .6s ease-out;
}

#container{width:100%;height:100vh;position:absolute;top:0;left:0;display:none;}
</style>
</head>
<body>

<div id="intro">
    <div id="heartBtn"></div>
    <div id="loadingBar"><div id="loadingFill"></div></div>
</div>

<div id="flash"></div>
<div id="container"></div>

<audio id="bgMusic" src="assets/music.mp3" loop preload="auto"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<script>
const heartBtnContainer = document.getElementById("heartBtn");
let introScene, introCamera, introRenderer, introHeart, introAnimationId;

// ==== INTRO HEART ====
function initIntroHeart(){
    introScene = new THREE.Scene();
    introCamera = new THREE.PerspectiveCamera(75, heartBtnContainer.clientWidth/heartBtnContainer.clientHeight, 0.1, 1000);
    introCamera.position.z = 40;

    introRenderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    introRenderer.setSize(heartBtnContainer.clientWidth, heartBtnContainer.clientHeight);
    heartBtnContainer.appendChild(introRenderer.domElement);

    const heartShape = new THREE.Shape();
    const scale = 1.4; 
    for(let i=0;i<=200;i++){
        let t = i/100 * Math.PI*2;
        let x = 16*Math.pow(Math.sin(t),3)*scale;
        let y = (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))*scale;
        if(i===0) heartShape.moveTo(x,y);
        else heartShape.lineTo(x,y);
    }

    const geometry = new THREE.ExtrudeGeometry(heartShape,{
        depth:4,
        bevelEnabled:true,
        bevelSegments:3,
        steps:1,
        bevelSize:0.5,
        bevelThickness:0.5
    });

    const material = new THREE.MeshPhongMaterial({color:0xff8fdc, shininess:200, specular:0xffffff});
    introHeart = new THREE.Mesh(geometry, material);
    introScene.add(introHeart);

    const ambientLight = new THREE.AmbientLight(0xffffff,0.8);
    introScene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff,0.5);
    directionalLight.position.set(20,20,20);
    introScene.add(directionalLight);

    animateIntroHeart();
}

function animateIntroHeart(){
    introAnimationId = requestAnimationFrame(animateIntroHeart);
    introHeart.rotation.y += 0.02;
    introRenderer.render(introScene,introCamera);
}
initIntroHeart();

// ==== CLICK TO START ====
document.getElementById("heartBtn").addEventListener("click",()=>{
    document.getElementById("loadingBar").style.opacity="1";
    loadAnim();
});

function loadAnim(){
    let w=0;
    const fill=document.getElementById("loadingFill");
    let t=setInterval(()=>{
        w+=3; fill.style.width=w+"%";
        if(w>=100){ clearInterval(t); explodeFlash(); }
    },40);
}

function explodeFlash(){
    cancelAnimationFrame(introAnimationId);
    introRenderer.dispose();

    const f=document.getElementById("flash");
    f.style.opacity="1";
    setTimeout(()=>{
        f.style.opacity="0";
        document.getElementById("intro").style.opacity="0";
        setTimeout(()=>document.getElementById("intro").style.display="none",500);
        document.getElementById("container").style.display="block";
        preloadImages(initGalaxy);

        const bgMusic = document.getElementById("bgMusic");
        if(bgMusic.readyState >= 4){ 
            bgMusic.play().catch(e=>console.log(e));
        } else {
            bgMusic.addEventListener("canplaythrough", ()=>bgMusic.play(), {once:true});
        }
    },200);
}

// ==== GALAXY ====
let scene,camera,renderer,controls;
let orbitObjects=[];
const textList=[
"Em y√™u anh r·∫•t nhi·ªÅu!","Anh l√†m v·ª£ em nh√©!","Nh·ªõ anh r·∫•t nh√¨u","17/08/2002",
"E.r.A with Love","ƒêi·ªÅu tuy·ªát v·ªùi nh·∫•t","Tri k·ª∑","ìáº","ìÜù","‚ãÜ","Àö"
];
const images=[
"assets/image1.jpg","assets/image2.jpg","assets/image3.jpg",
"assets/image4.jpg","assets/image5.jpg","assets/image6.jpg",
"assets/image7.jpg","assets/image8.jpg","assets/image9.jpg",
"assets/image10.jpg","assets/image11.jpg","assets/image12.jpg"
];
let loadedTextures = [];

function preloadImages(callback){
    const loader = new THREE.TextureLoader();
    let loadedCount = 0;
    for(let i=0;i<images.length;i++){
        loader.load(images[i], function(tex){
            loadedTextures[i] = tex;
            loadedCount++;
            if(loadedCount === images.length){
                callback();
            }
        });
    }
}

function initGalaxy(){
    const container = document.getElementById("container");

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 0.1);

    renderer = new THREE.WebGLRenderer({antialias:false, alpha:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.target.set(0, 0, 0);
    controls.enablePan = false;
    controls.enableZoom = true;

    addStars();

    // T·∫°o 230 object: 30 ·∫£nh v√† 200 text
    for(let i=0;i<30;i++) newOrbitObject("image");
    for(let i=0;i<200;i++) newOrbitObject("text");

    animate();
}

function addStars(){
    const starCount = 5000; 
    const positions = [];
    const colors = [];

    for(let i=0;i<starCount;i++){
        const x = THREE.MathUtils.randFloatSpread(400);
        const y = THREE.MathUtils.randFloatSpread(400);
        const z = THREE.MathUtils.randFloatSpread(400);
        positions.push(x,y,z);

        const color = new THREE.Color(0xffffff);
        color.offsetHSL(0,0,Math.random()*0.5);
        colors.push(color.r, color.g, color.b);
    }

    const geometry = new THREE.BufferGeometry();
    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions,3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));

    const material = new THREE.PointsMaterial({size:0.2, vertexColors:true});
    const points = new THREE.Points(geometry, material);
    scene.add(points);
}

function newOrbitObject(forceType=null){
    let mesh, type;

    if(forceType==="image" || (forceType===null && Math.random() > 0.95)){
        type="image";
        let tex = loadedTextures[(Math.random()*loadedTextures.length)|0];
        let geo = new THREE.PlaneGeometry(2.6,2.6);
        let mat = new THREE.MeshBasicMaterial({map:tex, transparent:true, side:THREE.DoubleSide});
        mesh = new THREE.Mesh(geo, mat);
    } else {
        type="text";
        let txt = textList[(Math.random() * textList.length) | 0];
        let canvas = document.createElement("canvas");
        canvas.width = 1024; canvas.height = 128; // gi·∫£m ƒë·ªô ph√¢n gi·∫£i
        let ctx = canvas.getContext("2d");

        ctx.font = "bold 40px Arial";
        ctx.fillStyle = "#ffcfff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "#ff69ff";
        ctx.shadowBlur = 15;
        ctx.fillText(txt, canvas.width/2, canvas.height/2);

        let tex = new THREE.CanvasTexture(canvas);
        let geo = new THREE.PlaneGeometry(18, 3);
        let mat = new THREE.MeshBasicMaterial({map: tex, transparent:true, side:THREE.DoubleSide});
        mesh = new THREE.Mesh(geo, mat);
    }

    mesh.material.opacity = 1;

    let R = 12 + Math.random()*8;
    let theta = Math.random()*Math.PI*2;
    let y = (Math.random()*2 - 1)*R;

    orbitObjects.push({
        mesh,
        type,
        R,
        theta,
        y,
        life: Math.random(),
        spiral: Math.random()*Math.PI*2,
        speed: 0.004 + Math.random()*0.006
    });
    scene.add(mesh);
}

function animate(){
    requestAnimationFrame(animate);
    for(let o of orbitObjects){
        o.life += 0.003 + Math.random()*0.004;

        if(o.type === "text" && o.life > 1){
            o.mesh.material.opacity -= 0.008; 
            if(o.mesh.material.opacity <= 0){
                scene.remove(o.mesh);
                orbitObjects.splice(orbitObjects.indexOf(o),1);
                newOrbitObject("text");
                continue;
            }
        }

        if(o.type==="image" && o.life > 3){ 
            o.life=0;
        }

        o.theta += o.speed;
        o.spiral += 0.004;

        let ring = Math.sqrt(o.R*o.R - o.y*o.y);
        let wave = Math.sin(o.spiral)*0.6;

        let x = (ring + wave*Math.sin(o.theta))*Math.cos(o.theta);
        let z = (ring + wave*Math.cos(o.theta))*Math.sin(o.theta);
        let y = (o.y*0.5) + Math.sin(o.theta*2)*0.3;

        o.mesh.position.set(x, y, z);
        o.mesh.lookAt(new THREE.Vector3(0,0,0));
    }
    controls.update();
    renderer.render(scene, camera);
}

window.addEventListener("resize",()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
